%!PS-Adobe-3.0
%%Title: Code Snippet
%%Version: 1.0
%%Creator: John O'Hanley
%%CreationDate: 2026-02-18
%%LanguageLevel: 3.0
%%DocumentMedia: Plain 612.0 792.0 60 white ()
%%DocumentNeededResources: font Helvetica Helvetica-Oblique Consolas Consolas-Italic
%%BoundingBox: 0 0 612 792
%%Orientation: Portrait 
%%Pages: 1
%%EndComments 

%%BeginDefaults 
%%EndDefaults

%%BeginProlog

%  RENDER A CODE SNIPPET WITH A FIXED-WIDTH FONT. COMMENTS IN ITALICS.

% lines-dict
% render lines of text with fixed line breaks.
% the current point must exist.
% at the end of this proc, the currentpoint will be one line below the last line.
% SEE EXAMPLE DICT BELOW.
/code-snippet {
  4 dict begin
    { def } forall 
    currentpoint
    /y0 exch def
    /x0 exch def
    /line-count 0 def
    lines {
      % line: an array of procs
      {
        % a run in a line
        exec
      } forall
      % new line: set the starting position (CR + LF)
      /line-count line-count 1 add def
      x0
      y0 line-count leading mul sub
      moveto
    } forall
  end
} def

% str
% render a snippet of code with no line breaks
/CODE {
  (code) 100 use-font show
} def

% str
% render a snippet of code comment with no line breaks
/COM {
  0.5 setcolor
  (code-comment) 100 use-font show
  0 setcolor
} def

% str
% render a snippet of poetry with no line breaks
/POE {
  (italic) 100 use-font show
} def

% new-name old-name 
% create a new font from an existing one, which uses the ISOLatin1Encoding instead of the standard encoding.
% NOTE: THE ENCODING OF THIS POSTSCRIPT FILE IS ITSELF 8859-1 = ISOLatin1.
% calling this allows (almost all) accented characters in West European languages to be treated as any other character.
% https://stackoverflow.com/questions/270672/unicode-in-postscript
/latinize {
  findfont
  dup length dict 
  begin
    % copy everything in the source font's dict except for the FID (a unique id for a font)
    { 1 index /FID ne {def}{pop pop} ifelse } forall
    /Encoding ISOLatin1Encoding def % override the encoding entry in this dict
    currentdict  % push this font-dict onto the operand stack
  end
  definefont  % internally sets a FID (font-id) for the new font
  %pop % remove the new font object from the operand stack
  1 dict begin
    % log the font information
    /the-new-font exch def
    (Latinized font. /FontName:) the-new-font /FontName get == ==
    ( /FontType:) the-new-font /FontType get == ==
    ( /FontMatrix scale-x:) the-new-font /FontMatrix get 0 get == ==
  end
} bind def

% the returned value may be a rounded value, slightly different from the expected value
% WARNING: this has only been tested with Type 1 and Type 42 fonts.
/current-font-size {
  % the font-size is part of the font-matrix
  % this depends on the fontmatrix, which in turn depends on the fonttype
  currentfont /FontMatrix get 0 get
  currentfont /FontType get 1 eq {
    % Adobe Type 1 fonts have a FontMatrix [0.001 0 0 0.001 0 0], not [1 0 0 1 0 0]
    1000 mul
  } if
  % DO ANY OTHER FONT TYPES HAVE A FONT MATRIX DIFFERENT FROM [1 0 0 1 0 0]?
} def

% str size
% set the font using an 'expected/configured' font name, and the font size
/use-another-font {
2 dict begin 
  /font-size exch def
  /font-name exch def
  % the 'my-fonts' dict is defined below
  my-fonts font-name known not {
    (DUDE, you're using an unknown font name.) ==
    font-name ==
  } if
  my-fonts font-name get 
  font-size
  selectfont
end 
} bind def

% str pct
% the font name, and the percentage of the DEFAULT font-size
% set the current font
/use-font {
  default-font-size exch pct
  use-another-font
} bind def

% str pct
% the font name, and the percentage of the CURRENT font-size
% set the current font
/r-use-font {
  current-font-size exch pct
  use-another-font
} bind def


/pct { 
  0.01 mul mul 
} bind def

% x-pct y-pct
% moveto, but expressed using percentages of the page width and height
/pmoveto {
  2 dict begin
    /y-pct exch def
    /x-pct exch def
    page-width x-pct pct
    page-height y-pct pct
    moveto
  end
} def

% str
% return the width/height (dx, dy) of the given text (in the current font)
% this is useful for centering in various ways
% https://stackoverflow.com/questions/3618194/how-to-determine-string-height-in-postscript luser droog
/text-dim {
  gsave
    0 0 moveto
    % the bounding box of the text
    false charpath flattenpath pathbbox % x0 y0 x1 y1
  grestore
  3 -1 roll sub % x0 x1 dy
  3 1 roll sub % dy -dx
  -1 mul % dy dx
  exch % dx dy
} bind def

% str -> number
% return the height of the given string in the current font
/text-height {
  text-dim % dx dy
  exch pop % dy 
} bind def

% num
% return a multiple of the height of capital 'M' in the current font
/em {
 (M) text-height mul
} bind def

%%EndProlog

%%BeginSetup               
  /page-width  8.5 72 mul def
  /page-height 11 72 mul def % absolute values
  <</PageSize [page-width  page-height]>> setpagedevice  
  << /NeverEmbed [ ] >> setdistillerparams  % always embed fonts
  true setstrokeadjust  % minimizes off-by-one-pixel line issues

  % Define new fonts that are 'latinized' versions of an existing font.
  /MyRegular /Helvetica latinize
  /MyItalic /Helvetica-Oblique latinize
  /MyCode /Consolas   latinize  
  /MyCodeComment /Consolas-Italic   latinize  
  % this dict allows easy lookup of my desired fonts  
  /my-fonts <<
    (regular) /MyRegular
    (italic) /MyItalic
    (code)  /MyCode
    (code-comment) /MyCodeComment
  >> def
  /default-font-size page-height 2 pct def  
%%EndSetup 

%%Page: 1 1
%%BeginPageSetup 
 /pgsave save def     
%%EndPageSetup

  (regular) 100 use-font
  
  5 93 pmoveto
  (Code snippet rendered with Consolas, a nice fixed-width font:) show
  
  5 87 pmoveto
  << 
    /leading 1.75 em
    /lines [
      [{(% a b pct -> return b percent of a)COM}]
      [{(% percentage of a given value )COM}]
      [{(/pct {)CODE}]
      [{(  0.01 mul mul)CODE} {( % example: 60 10 pct -> 6)COM} ]
      [{(} bind def)CODE}]
    ]
  >> code-snippet
  (regular) 100 use-font
  
  5 70 pmoveto
  (The same technique can be used for any text with fixed line breaks:) show
  5 64 pmoveto
  << 
    /leading 1.75 em
    % this could easily be made more curt, as a simple array of strings
    /lines [
      [{(O thou dissembling cub! What wilt thou be,)POE}]
      [{(When time hath sowed a grizzle on thy case?)POE}]
      [{(Or will not else thy craft so quickly grow)POE}]
      [{(That thine own trip shall be thine overthrow?)POE}]
      [{(Farewell, and take her, but direct thy feet)POE}]
      [{(Where thou and I henceforth shall never meet.)POE}]
    ]
  >> code-snippet


pgsave restore
showpage
%%PageTrailer
%%Trailer    
%%EOF 